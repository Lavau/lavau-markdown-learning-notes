[TOC]

# 10.1  执行引擎概述

## 10.1.1  概述

- JVM 核心部分之一
- 任务：**将字节码指令解释 / 编译为对应平台上的本地机器指令**

## 10.1.2  执行引擎的工作过程

<img src="E:\mdFiles\JVM\尚硅谷-JVM视频学习笔记\picture\chapter12-1.png" width="75%">

# 10.2  Java 代码编译和执行过程

- 解释器

  JVM 启动后按预定义规范对字节码逐行解释执行，将每条字节码的内容 ”翻译“ 为对应平台的机器指令

- 编译器

  JVM 直接将字节码编译为对应平台的机器指令

- Java 是半编译半解释型语言

  JVM 执行 Java 代码时，通常将解释执行与编译执行结合进行

## 10.2.1  过程

<img src="E:\mdFiles\JVM\尚硅谷-JVM视频学习笔记\picture\chapter12-2.png" width="45%">

# 10.3  机器码、指令、汇编语言

> 观看视频  112P - 机器码-指令-汇编-高级语言理解与执行过程，简单了解



# 10.4  解释器

> 观看视频  112P - 解释器的使用，简单了解



# 10.5  JIT 编译器

Hotspot 采用解释器与 JIT 编译器并行的架构。

JIT 编译器的执行速度比解释器快；

解释器的响应速度比 JIT 编译器快。

## 10.5.1  Hotspot VM 的执行过程

> VM 启动，解释器先发挥作用，省去不必要的编译时间。
>
> 随着程序的运行，JIT 编译器开始发挥作用 —— 根据热点探测功能，将有价值的字节码编译为本地机器指令。

## 10.5.2  热点代码及探测方式

> 是否启用 JIT 编译器，由代码被执行调用的频率决定。
>
> 那些被直接编译的字节码又被称为 ”**热点代码**“。
>
> 在运行时，JIT 编译器**深度优化**热点代码，将其直接编译为对应平台的机器指令。

- 栈上替换（OSR -- on stack replacement）

  热点代码：一个被多次调用的方法或一个方法体内循环次数较多的循环体

  JIT 编译器将热点代码编译为本地机器指令，发生在方法执行过程中。所有这种编译方式又称为 **栈上替换**

- Hotspot 采用 **基于计数器的热点探测** 方式、

  采用基于计数器的热点探测，Hotspot 为每个方法建立 2 个不同类型的计数器：方法调用计数器（Invocation Counter）与回边计数器（Back Edge Counter）

### 10.5.2.1  方法调用计数器

- 作用

  统计方法的调用次数

- 默认阈值

  client：1500 

  server：10000

- 阈值设定

  `-XX:CompileThreshold`

- **热度衰减**

  如果不做任何设置，方法调用计数器统计的是一个相对的执行频率（一段时间内方法被调用的次数）。

  超过时间限度，方法被调用的次数不够，该方法的调用计数器减半。这个过程称为 **方法调用计数器热度的衰减**，这段时间为该方法的 **半衰周期**。

  - 相关参数

    - `-XX:-UseCounterDecay`

      关闭热度衰减——让方法计数器统计方法调用的绝对次数

    - `-XX:CounterHalfLifeTime`

      设置半衰周期的时间，单位：s

- 判断流程

  <img src="E:\mdFiles\JVM\尚硅谷-JVM视频学习笔记\picture\chapter12-3.png" width="45%">

  

### 10.5.2.2  回边计数器

- 作用

  统计循环体被执行的循环次数

- 判断流程

  <img src="E:\mdFiles\JVM\尚硅谷-JVM视频学习笔记\picture\chapter12-4.png" width="45%">


## 10.5.3  Hotspot 设置程序执行方式

> Hotspot 默认采用解释器与编译器并存的模式。

可以通过命令显示地指定运行时完全采用解释器还是编译器：

- `-Xint`

  完全采用解释器

- `-Xcomp`

  完全采用编译器。如果即时编译出错，解释器将介入

- `-Xmixed`

  采用解释器 + 编译器的混合模式

在命令行运行  `java -X...` 可以指定运行时代码的执行方式，通过 `java -version` 查看。











