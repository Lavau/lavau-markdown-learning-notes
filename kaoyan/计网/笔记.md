[TOC]

## 一、计算机网络和因特网

##  1.1 什么是因特网

1. 主机与端系统直接是没有区别的，它们是交换使⽤的。

2. 端系统通过通信链路和分组交换机连接到一起。

3. 分组交换机：路由器（用于网络核心中）和链路层交换机（用于接入网中）

4. 路径：一个分组从源端系统到目的端系统经过的一系列通信链路和分组交换机。

5. 端系统通过 ISP （Internet Service Provider）接入因特网。ISP 的本质是多条分组交换机和多条通信链路组成的网络。

6. 分组交换机帮助实现端系统间的数据传输，数据要被端系统上的应用程序使用。

7. 套接字接口规定了一个端系统上的应用程序通过接入因特网向另一端接入因特网的一台端系统交付数据的方式。它是一个发送程序遵守的一套规范。

**问题：请用自己的话描述下因特网（从软硬件的组成和根据基础设施提供的服务两个角度）**

8. <span style="color: red; font-weight: bold;">协议（P6）</span>：定义了在两个或多个通信实体间交换的报文的格式和顺序，以及报文发送或接受一条报文或其他事件所采取的动作。

9. 因特网中，进行交流的通信实体的所有动作都受到协议的制约。
10. 标准对于协议来说是重要，正是标准的协议让人们创造出可以相互协作的网络系统和设备。

## 1.2 网络边缘

1. 端系统：与因特网相连的计算机或其他设备。

2. 主机 = 端系统，可分为两类：客户机和服务器

3. 各个端系统位于网络边缘，通过接入网，连接到因特网。

4. 接入网：

   - 家庭接入
     - 方式：DSL（电话线接入）、电缆、FTTH（光纤）、拨号、卫星
     - 通过 LAN 将端系统和边缘路由器连起来
   - 公司
     - 方式：以太网、Wi-Fi
   - 广域无线接入
     - 方式：4G、LTE

5. **HFC 带宽 **是由⽤⼾ **共享 ** ；下⾏通道中 **没有碰撞**  —— 因为下⾏通道中，所有的包都是由头端这⼀个 **单⼀源** 发出的。

6. 以太 LAN 传输速率：10M、100M、1G、10G

   

7. |                |            |
   | -------------- | ---------- |
   | *HFC*          | *带宽共享* |
   | FTTH           | 带宽专⽤   |
   | 拨号调制解调器 | 带宽专⽤   |
   | DSL            | 带宽专⽤   |

## 1.3 网络核心

1. 网络核心是由端系统的分组交换机和通信链路组成的网状网络。

### 1.3.1 分组交换

1. 分组：源端系统向目的端系统发送报文，源端系统将长报文划分成小的数据块。
2. 分组以通信链路最大传输速率传输。
3. 储存转发：交换机开始向输出链路传输该分组的第一个比特前，要接收到整个分组。
4. 每个分组交换机有多条链路；一条链路一个输出缓存，存储发往该链路的分组。因此，排队的分组有一个排队时延。
5. 丢包：输出缓存满了，已到达的分组或在排队的分组之一会被丢弃

### 1.3.2 电路交换

1. 电路交换：端系统通信时，预留了沿路径通信所需的缓存、传输速率等资源。要知道，分组交换中，这些资源不预留。
2. <span style="color: red; font-weight: bold;">电路交换与分组交换对比</span>：
   - 电路交换：
     - 电路交换中，发送方发送数据前，要与接收方建立一条  **名副其实的连接**  ；
     - 并且，这条链路上的分组交换机要  **维护连接**  ；
     - 在这条链接上，发送方能够以  **恒定的传输速率**  向接收方传输数据。
   - 分组交换：
     - 分组通过  **一系列通信链路**  传输；
     - 不预留任何链路资源 —— 与其它分组使用同一链路时，会  **拥塞**  ；
     - **尽力交付 ** 分组，但不做保证。
3. 电路交换⽹络可以在响应时间内保证⼀定量的端到端带宽；但大部分分组交换网络无法保证端到端带宽。
4. 在电路交换中，TDM 比 FDM 有的优点：
   - FDM需要复杂的模拟硬件将信号转换为 合适的频率

## 1.4 分组交换中的时延、丢包和吞吐量

1. 分组在沿途每个节点都会经历不同类型的时延。

   - 节点总时延：节点处理时延 + 排队时延 + 传输时延 + 传播时延
   - d<sub>nodal </sub> =  d<sub>proc</sub>  +  d<sub>queue</sub>  +  d<sub>trans</sub>   +  d<sub>prop</sub> 
   - 除了排队时延是变化的外，其它三种时延都是固定的

2. 分组丢失的比例随流量强度的增加而增加。

3. 理解端到端的时延，可以做一下：**Traceroute 实验**

   

## 1.5 协议层次及其服务模型

1. 网络设计者以  **分层的方式**  组织协议以及实现协议的软硬件。

2. 一个协议层通过软件、硬件或软硬间结合的方式实现：应用层、传输层的协议几乎都是端系统上运行的软件实现的；而网络层和链路层则是软硬结合。

3. 传输层在应用程序端点之间传输报文；

   网络层是将报文段从一台主机移动到另一台主机，通过源和目的地之间的路由器路由数据报；

4. 链路层可靠的数据传输服务不同于传输层的数据可靠传输服务，传输层的数据可靠传输服务是从一个端系统到另一个端系统。

5. <span style="color: red; font-weight: bold;">封装 :</span> 发送主机端，一个应用层报文被传送给运输层。在最简单的情况下，运输层收取到该报文并附上附加信息，生成运输层报文段。运输层向网络层传递该报文段，网络层增加网络层首部信息，生成数据包。该数据报传递给链路层，链路层添加链路层首部信息，生成链路层帧。

6. <span style="color: red; font-weight: bold;">协议分层</span> ：<img src="E:\lavau-markdown-learning-notes\kaoyan\计网\计网体系结构.png" style="height: 250px;">一个应用层报文被传给运输层；

   最简单的情况下，运输层接收该报文并附上首部信息，一同构成报文段；

   运输层向网络层传递该报文段，网络层添加网络层的首部信息，生成网络层数据报；

   数据报传递给链路层，链路层添加链路层信息，形成帧。

   然后，该帧通过物理层经由链路层交换机和路由器的传输，最后，到达目的端。

   到达目的端后，端系统从链路层开始，逐层向上分解首部信息，最后得到原来的应用层报文。



## 1.6 面对攻击的网络

1. 病毒：通过某种用户交互感染用户设备的恶意软件。

   蠕虫：无须任何明显的用户交互、直接进入用户设备的恶意软件。

2. *如何生成一个僵尸网络，以及僵尸网络怎样被用于 DDoS 攻击的？*

   攻击者发现⼀些应⽤或系统的薄弱点。发现薄弱点后，攻击者需要查找可攻击的主机。⽬标⼀般是已发现漏洞的⼀系列系统。僵⼫⽹络中的任何系统都可以通过漏洞⾃动扫描它的环境，传播恶意软件。这种僵⼫⽹络的重要属性就是僵⼫⽹络的起点可以远程控制和发送命令⾄僵⼫⽹络中的所有结点的每⼀个节点。



# 二、应用层

## 2.1 应用层网络协议

1. 研发网络应用的核心：能运行在不同的端系统上；通过网络彼此通信。

2. 将应用软件限制在端系统，促进了网络应用程序的迅速研发与部署。

3. 网络应用体系结构由应用开发者设计，规定如何在各种端系统上组织该应用程序。现代网络应用程序主流的体系结构：客户 —— 服务器体系结构、对等（P2P）体系结构。

4. 客户 —— 服务器体系结构：

   一个常打开的主机成为 <u>*服务器*</u>，响应客户机的请求。

   客户机之间不能相互通信；服务器的 IP 地址固定并且所有客户机都知道。

5. P2P 的体系结构：

   对服务器有较小的（甚至没有）依赖；应用程序的主机间可以相互通信，彼此称为对等方。

6. 不同端系统上的进程，通过计算机网络交换报文，进行通信。发送进程生成报文，并通过计算机网络传输；接收进程接受该报文并可能通过回送报文做出响应。

7. 客户机与服务器：在一对会话的进程中，发起会话的进程称为客户，在会话开始等待联系的进程称为服务器。

8. 进程通过套接字接口向网络发送报文和从网络接收报文。也就是套接字是同一台主机内应用层与传输层的接口。

9. 应用开发者可控制套接字的应用层端的一切，但对于运输层端 *<u>几乎没有</u>* 控制权。

10. IP 标识主机，端口标识主机上可通信的不同进程。

11. Web 服务器端口号为 80，邮件服务器的端口号为 25.

12. 运输层对应用程序服务的要求：

    - 可靠数据传输

      接受进程接收到的报文与发送进程发送的报文内容一致

    - 吞吐量

      可用吞吐量：发送进程向接收进程交付比特的速率。

      r 比特 **/** 秒

    - 定时

    - 安全

    - 数据完整

    - 端点鉴别

13. SSL 在应用层工作。

14. 因特网提供的运输服务（运输层协议简介）：

    1. TCP

       面向连接：

       - 在应用程序交换报文前，先交换运输层的控制信息。
       - 一个 TCP 连接建立在客户与服务器的套接字接口间。
       - 全双工
       - 在会话结束前，要先断开连接。

       可靠的数据传输：

       - 保证数据从发送方无差错、按适当顺序达到接收方。

    2. UDP

    *因特网运输层协议并未实现     “ 对应用程序服务的要求 ”   中的全部内容。*

15. <span style="color: red; font-weight: bold;">应用层协议的原理 ：</span> 

    应用层协议规定了不同端系统上的应用程序如何传递报文。特别的应用层协议定义了：

    - 交换的报文类型：请求报文、响应报文
    - 各种报文类型的语法：定义哪些字段，如何描述字段
    - 字段含义
    - 确定一个进程何时以及如何发送报文，对报文响应的规则。

## 2.2 Web 和 HTTP 

1. Web 提供为用户提供按需操作 —— 用户需要什么内容，就从 Web 上获取该内容。

2. Web 的应用层协议是 HTTP；

   HTTP 是 Web 的核心，在 RFC 中进行定义。

3. HTTP 由两个程序实现：一个客户端程序和一个服务器程序。它们分别运行在不同的端系统上，通过 HTTP 报文会话。

   HTTP 协议规定 报文的结构<span style="color: red; font-weight: bold;"><sup>(1) </sup></span> 以及客户和服务器交换报文的方式<span style="color: red; font-weight: bold;"><sup>(2) </sup></span>  。

4. <span style="color: red; font-weight: bold;"><sup>(1) </sup></span>HTTP 报文：

   1. 请求报文：

      第一行叫请求行，后继的行叫首部行。

      请求行有 3 个字段：方法字段、URL、HTTP 版本

   2. 响应报文：

      状态行、首部行、实体行

5. <span style="color: red; font-weight: bold;"><sup>(2) </sup></span>Web 页面有对象组成，一个文件就是一个对象。

   HTML 文件通过对象的 URL 地址引用页面中的其他对象。

   URL = 存放对象的服务器地址 + 对象的路径名

6. <span style="color: red; font-weight: bold;"><sup>(2) </sup></span>HTTP 使用 TCP 作为运输层协议。

7. <span style="color: red; font-weight: bold;"><sup>(2) </sup></span>HTTP 协议是一个无状态协议 —— 服务器（向客户发送被请求的文件，但）不储存关于客户的状态信息。

8. <span style="color: red; font-weight: bold;"><sup>(2) </sup></span>HTTP 的默认端口号为 80，也是 Web 的默认端口号。

9. <span style="color: red; font-weight: bold;"><sup>(2)</sup></span>非持续连接：客户每次向服务器发起请求，都建立一个 TCP 连接。即：每个 TCP 连接只传输一个请求报文和一个响应报文。

   <u>粗略地讲，总的响应时间是两个 RTT（一个 RTT 创建 TCP 连接，另一个 RTT 请求和接受一个对象） 加上服务器传输 HTML 文件的时间</u>（P67）。

10. cookie 技术：

    1. cookie 技术的四个组成：
       - HTTP 请求报文有一个 cookie 首部行
       - HTTP 响应报文有一个 cookie 首部行
       - 客户端系统保留一个 cookie 文件
       - 服务器站点有一个数据库，保存 cookie 信息
    2. cookie 在无状态的 HTTP 协议之上建立一个用户会话层。

11. Web 缓存器既是服务器又是客户。

12. 部署 Web 缓存器的两个原因：

    1. 减少对客户的响应时间
    2. 降低因特网的 Web 流量

    

## 2.3 因特网中的电子邮件

1. <span style="color: red; font-weight: bold;">电子邮件系统的组成：</span>

   1. 用户代理

      - 用户代理允许用户阅读、回复、撰写报文

   2. 邮件服务器

      - 它是电子邮件系统的核心

      - 接收方在邮件服务器上有一个邮箱，邮箱管理并维护里面的报文

   3. 简单邮件传输协议（SMTP）

      - 要求运输层使用 TCP
      - 从用户代理向邮件服务器发送邮件
      - 从发送方的邮件服务器向接收方的邮件服务器发送邮件

2. SMTP 限制所有电子邮件报文的体部分只能采用 7 比特 ASCII 表示。

3. <span style="color: red; font-weight: bold;">电子邮件的发送过程：</span>

   ① 发送方的邮件代理程序提供接收方的邮件地址，并指示用户代理发送报文到他的邮件服务器，在那里该报文被放到报文列表；② 邮件服务器创建一条到接收方邮件服务器的 TCP 连接，通过该连接使用 SMTP 协议发送报文；③ 接收方的邮件服务器接收该报文，并把它放到接收方的邮箱中；④ 接收方通过他的用户代理阅读报文。

4. SMTP 一般不使用中间邮件服务器发送报文。

5. SMTP 的默认端口号为 25.

6. <span style="color: red; font-weight: bold;">SMTP 如何将一个报文从发送方电子邮件服务器发送到接收方电子邮件服务器：</span>

   ① 客户 SMTP 先与服务器 SMTP 建立一条 TCP 连接；② 客户 SMTP 和服务器 SMTP 相互介绍彼此，介绍完成后，客户 SMTP 发送邮件给服务器 SMTP；③ 如果客户 SMTP 没有别的报文发送，它指示 TCP 断开连接。

7. SMTP 与 HTTP 对比：

   |             SMTP             |             HTTP             |
   | :--------------------------: | :--------------------------: |
   |            推协议            |            拉协议            |
   | 每个报文采用 7 位 ASCII 编码 |     HTTP 数据不受此限制      |
   | 把所有报文对象放在一个报文中 | 把每个对象放在它的响应报文中 |

8. 使用 HTTP 协议将邮件从用户代理发送到邮件服务器；

   使用 POP3、IMAP、HTTP 协议将电子邮件从邮件服务器传送到用户代理。

9. 用户代理到邮件服务器的端口为 110.

## 2.4 DNS：因特网的目录服务

1. 标识主机的两种方式：主机名和 IP 地址。

2. DNS 是 ① 一个由分层的 DNS 服务器实现的分布式数据库，② 一个应用层协议。

3. DNS（Domain Name System） 将主机名转换为 IP 地址。

   DNS 使用 UDP，默认端口为 53.

4. 允许一个邮件服务器和 Web 服务器拥有相同的主机名。

   允许多个邮件服务器由相同的别名。

5. 在基于 UNIX 的机器上，应用程序转换主机名时，调用函数 `gethostbyname()`。

6. 单一 DNS 服务器面临的问题：

   - 单点故障
   - 通信容量
   - 远距离的集中式数据库
   - 维护

7. 

从 2.4.2、2.4.3，没有总结出内容 

## 2.5 P2P 文件分发

1. P2P 体系结构对服务器的依赖是比较小的，甚至没有依赖；而且各个对等方之间还可以互相通信。

2. 分发一个文件，客户 —— 服务器体系结构中，服务器向每个客户（对等方）发送一个副本；P2P 体系结构中，每个对等方可以向其它对等方发送它自己收到的文件的任何部分。

3. P2P 文件分发协议：`BitTorrent 协议`

4. 两种体系结构文件分发时间讨论：

   1. 客户 —— 服务器体系结构 ：

      - 服务器文件分发最小时间：NF / u<sub>s</sub>

      - 单个对等方最小分发时间：F / d<sub>min</sub>

      - D<sub>cs </sub> >= max { NF / u<sub>s</sub> ,  F / d<sub>min</sub> }，

        取下界作为 D<sub>cs</sub> 的值，则：D<sub>cs</sub> = max { NF / u<sub>s</sub> ,  F / d<sub>min</sub> }

   2. P2P 体系结构 ：

      - 服务器文件分发时间：F / u<sub>s</sub>

        （服务器只需分发一次，对等方之间会互相分发文件）

      - 单个对等方最小分发时间：F / d<sub>min</sub>

      - 总体最小的分发时间：NF / (u<sub>s</sub> + u<sub>1</sub> + ··· + u<sub>n</sub>)

      - D<sub>p2p</sub>  >=  max {  F / u<sub>s</sub> ,  F / d<sub>min</sub> ,  NF / (u<sub>s</sub> + u<sub>1</sub> + ··· + u<sub>n</sub>) }

        取下界作为 D<sub>p2p</sub> 的值，则：D<sub>p2p</sub> = max {  F / u<sub>s</sub> ,  F / d<sub>min</sub> ,  NF / (u<sub>s</sub> + u<sub>1</sub> + ··· + u<sub>n</sub>) }

5. BitTorrent 协议：

   1. 参与一个特定文件分发的所有对等方的集合称为一个洪流；
   2. 洪流中的对等放彼此下载等长度的文件块，一般为 256 KB；
   3. 每个洪流有一个基础设施节点：追踪器。它要求一个对等方加入洪流时，向追踪器注册自己，并周期性通知追踪器自己在洪流中。

6. <span style="color: red; font-weight: bold;">P2P 文件共享原理：</span>

   一个新的对等方加入洪流，追踪器会随机告诉它一个子集列表，该对等方可以与列表上的对等方建立 TCP 连接；

   该对等方会优先获取它的邻居中最稀缺的块，并会给为它提供最快速率的对等方优先权。

   该对等方要计算到邻居的速率，并更新之前等到的集合；每隔一段时间，会随机选择邻居发送块，如果某个邻居向它发送的速率高，这个邻居会获得它的优先权。它们会继续下去。不过不满足了，该对等方会选择新的邻居。

## 2.6 视频流和内容分发网（略）

## 2.7 套接字编程：生成网络应用（略）

> 特别注意的内容：
>
> 1. P67 上面关于往返时间的讨论
> 2. P79 2.3.4 邮件访问协议 的 POP3、IMAP 协议的内容



# 三、运输层

## 3.1 概述和运输层服务

1. 运输层为运行在不同端系统上的应用程序（进程）提供逻辑通信功能。

   网络层提供主机间的逻辑通信。

2. 运输层协议在端系统上实现，即运输层协议只工作在端系统上。

3. 运输层提供的服务受限于底层网络层提供的服务模型，但运输层仍能提供网络层不能提供的服务。

4. 运输层的多路复用与多路分解：将主机间的交付服务扩展为进程间的交付服务。

5. <span style="color: red; font-weight: bold;">TCP 与 UDP 所提供的服务：</span>

   1. UDP：

      ①、差错检验；

      ②、进程到进程的数据交付

   2. TCP：

      ①、可靠的数据传输

      ②、拥塞控制

6. UDP 提供的是不可靠的服务；UDP 流量不可控，发送进程按它自己的意愿的速率发送分组。

## 3.2 多路复用与多路分解

1. 多路分解：将运输层报文段中的数据运输到正确的套接字接口。

   多路复用：从源主机各个套接字接口收集数据块，为每个数据块加上首部信息形成报文段，并将这些报文段传递到网络层。

2. FTP 的端口号为 21.

3. 运输层如何进行分解服务：

   主机上的每个套接字有一个端口号；运输层检查报文段中的目的端口号，将该报文段发送到相应的套接字，报文段中的数据通过套接字进入它所连接的进程。

4. UDP 套接字由一个目的 IP 地址和一个目的端口号组成；UDP 套接字相同发送到目的主机同一个套接字。

   TCP 套接字由源 IP 地址、源端口号、目的 IP 地址、目的端口号组成；TCP 套接字相同发送到目的主机同一个套接字。

5. 进程与套接字并非一一对应。

## 3.3 无连接传输：UDP

1. DNS 使用 UDP 作为运输层协议。

2. 使用 UDP 的应用仍可以保证数据的可靠传输，可以通过应用程序自身建立可靠性机制完成。

3. <span style="color: red; font-weight: bold;">TCP 与 UDP 所提供的服务：</span>

   1. UDP：

      ①、差错检验；

      ②、进程到进程的数据交付

   2. TCP：

      ①、可靠的数据传输

      ②、拥塞控制

4. <span style="color: red; font-weight: bold;">TCP 与 UDP 提供服务的区别：</span>

   |          TCP           |                UDP                 |
   | :--------------------: | :--------------------------------: |
   |        面向连接        |               无连接               |
   | 提供可靠的数据传输服务 |           数据传输不可靠           |
   |        拥塞控制        |   发送方按任何自愿的速率传输数据   |
   |        流量控制        | 不能保证发送方速率与接收方速率匹配 |

   

## 3.4 可靠数据传输原理

1. TCP 向因特网应用提供的服务模型：

   数据在一条可靠信道上传输。该信道保证数据不受损坏或丢失，并且按发送顺序交付。

2. TCP 是在不可靠的网络层上实现的可靠数据传输协议。

3. 可靠数据传输的要点：校验和、序号、定时器、肯定和否定确认

4. ARQ（自动重传请求）协议处理比特处理的三种技术：

   1. 差错检验

      使用校验和进行差错检验

   2. 接收方反馈

      ACK（肯定确认）与 NAK（否定确认）

   3. 重传

5. 可靠数据传输机制及其用途总结

   | 机制         | 用途和说明                                                   |
   | ------------ | ------------------------------------------------------------ |
   | 检验和       | 检查一个分组中的比特是否出错                                 |
   | 定时器       | 用于超时重传分组，可能的原因分组传输超时或 ACK 丢失          |
   | 序号         | 用于对流向接收方的数据按顺序编号。接收序号间的间隙让接收方检查丢失的分组；重复的序号让接收方判断冗余的分组 |
   | 确认         | 接收方接收到一个或一组无误的分组时，向发送方反馈一个确认报文。报文会携带分组的序号 |
   | 否定确认     | 接收方接收到一个或一组有误的分组时，向发送方反馈一个报文，请求重传该部分分组 |
   | 窗口、流水线 | 发送方待发送的分组被限制在一个指定范围内。窗口长度可根据接收方接收和缓存报文的能力、网络的拥塞状态或两者情况设置 |



## 3.5 面向连接的运输：TCP

1. TCP 建立的连接是一条逻辑连接，连接的状态保存在通信端系统的 TCP 程序中。

2. TCP 连接是全双工、点到点的。

3. TCP 的三次 “握手”：

   1. 客户向服务器发送一个特殊的 TCP 报文段，请求建立连接；
   2. 服务器用另一个特殊的 TCP 报文段进行响应；
   3. 客户再用第三个特殊的 TCP 报文段进行响应。

   注意：前两个报文段不承载有效数据；第三个可以
   
4. 发送进程将发送的数据传送给套接字后，数据被 TCP 控制了。TCP 先将数据引导到该连接的发送缓存（三次握手期间设置）中，然后在适当时刻，TCP 会传递数据给网络层（TCP 规范中，并没有具体要求何时发送）。当 TCP 的另一端接受一个报文段时，报文段中数据被放在 TCP 连接的接收缓存中，应用程序从接收缓存中取数据。

5. 一个 TCP 连接的组成：一台主机上的缓存、变量和与进程相连的套接字，另一台主机上的缓存、变量和与进程相连的套接字。

6. MSS （最大报文段长度）：由本地发送主机发送的 MTU（最大链路帧长度）设置。

   **注意：**

   <u>*MSS 指报文段中应用层数据最大的长度，而不是指包括首部的 TCP*</u>

    <u>*报文段的最大长度。*</u>

7. TCP 报文段由首部字段和数据字段组成。

8. TCP 报文段中标志字段的含义：

   - ACK：对已被成功接收的报文段进行确认。
   - RST、SYN、FIN：用于连接的建立和删除。

9. TCP 把数据看成无结构、有序的字节流。因为 TCP 报文段首部中的序号字段是建立在传送的字节流之上，而不是建立在传送的报文段的序列上。

10. 首部的序号字段是该报文段数据字段首字节的字节流编号。

11. 一条 TCP 连接的双方均可随机选择初始序号。

12. 首部中的确认号字段是发送主机期望从接收主机那里收到的下一字节的序号。

13. Telnet 是一个应用层协议，用于远程登录，运行在 TCP 之上。

14. 一个发送方具有的未被确认的报文段数量由 TCP 的流量控制和拥塞控制共同决定。

15. TCP 的可靠数据传输保证接收方应用程序从接收缓存中取出的数据是无损坏、无间隙、非冗余和按序的。

16. TCP 发送方有 3 个与发送和重传有关的事件：

    1. 从应用程序接受数据

       TCP 向 IP 传输数据，如果发现定时器没有运行，则启动定时器

    2. 定时器超时

       TCP 通过重传响应定时器超时，并重启定时器

    3. 收到 ACK.

       如果还有未被确认的报文，则重启定时器

### 3.5.5 流量控制

1. 流量控制是一个速度匹配服务，即让发送方的发送速率与接收方的应用程序读取速率相匹配。
2. TCP 通过让发送方维护一个接收窗口的变量实现流量控制。

### 3.5.6 TCP 连接管理

1. 客户与服务器上的 TCP 建立连接：

   1. 客户的 TCP 向服务器的 TCP 发送一个 SYN 报文段。

      *SYN 报文段的首部的 SYN 标志位被置为 1；*

      *序号字段是客户随机选择的 .*

   2. SYN 报文段到达服务器。服务器为该连接分配 TCP 缓存和变量，并向客户发送允许连接的 SYNACK 报文段。

      *SYNACK 报文段的 SYN 标志位被置为 1；*

      *确认字段为原 SYN 报文段中序号字段值 + 1；*

      *序号字段是服务器随机选择的* .

   3. 客户接受 SYNACK 报文段，客户为该连接分配 TCP 缓存和变量。客户向服务器发送一个确认报文段。

      *该报文段的 SYN 标志位为 0；*

      *确认字段为原 SYNACK 报文段中序号字段值 + 1；*

      *序号字段是原 SYNACK 报文段中确认字段值 + 1 .*

2. 连接结束，主机中的缓存和变量被释放。

3. 客户与服务器上的 TCP 断开连接：

   1. 客户向服务器发送一个 TCP 报文段，请求断开连接。

      *该报文段的 FIN 标志位为 1.*

   2. 服务器接受该报文段，并向客户回送一个报文段；然后服务器再发送它自己的终止报文段。

      *该终止报文段的 FIN 标志位为 1.*

   3. 客户对终止报文段进行确认



## 3.6 拥塞控制原理

1. 区分控制方法：

   1. 端到端拥塞控制

      网络层不为拥塞控制提供显示支持。端系统通过观察网络行为推断是否发送拥塞。

   2. 网络辅助的拥塞控制

      路由器向发送方提供拥塞状态的信息

      - 两种反馈方式：
        1. 直接网络反馈
        2. 经由接收方的网络反馈



## 3.7 TCP 拥塞控制

1. TCP 使用的是端到端的拥塞控制（网络层的路由器不提供网络拥塞的反馈，需要发送方观察网络行为对拥塞进行判断）。

2. TCP 的拥塞控制：

   1. 限制发送方的发送速率

      通过 TCP 发送方设置拥塞窗口（cwnd）实现 TCP 的拥塞控制；

      拥塞窗口能限制发送方向网络发送数据的速率

   2. 发送方感知网络拥塞

      - TCP 发送方对丢包的定义：

        ①、定时器超时；②、收到 3 个冗余的 ACK

   3. 改变发送方的发送速率

      发送方根据对未确认分组的确认情况，修改拥塞窗口的值，改变发送方的发送速率

3. TCP 拥塞控制算法的 3 个主要部分：

   1. 慢启动
   2. 拥塞避免
   3. 快速恢复

   慢启动和拥塞恢复区别在对收到的 ACK 做出反应时增加拥塞窗口的长度的方式；慢启动能更快的增加拥塞窗口的长度。
   
4. 慢启动模式：TCP 刚开始传输时，cwnd 只有一个 MSS，每次发送的报文段得到确认后，下次 RTT 时，发送的 MSS 翻翻。如果出现拥塞，cwnd 的值变为 1，并且设置一个状态变量 ssthresh，设置为 cwnd / 2。当 cwnd 的值达到 ssthresh 时，TCP 结束慢启动，变为拥塞避免模式。

5. 拥塞避免模式：每个 RTT 只将 cwnd 的值增加一个 MSS。当出现丢包时，ssthresh 的值更新为 cwnd 的值 1/2。



>特别注意的内容:
>
>1. P133 3.3.2 节 UDP校验和的内容



# 四、网络层：数据平面

1. 路由器的数据平面的功能：到达路由器输入链路的数据报应该被送往路由器的哪个输出链路。
2. 路由器的控制平面的功能：数据报从源主机到目的主机所经过的路由器的路由方式。

## 4.1 网络层概述

1. 转发：分组从一个输入链路接口转移到该路由器上的适当的输出链接接口。

2. 路由选择：分组从源主机到目的主机的端到端路径的网络范围处理过程。 

3. 路由器有个转发表。路由器根据到达分组的首部的字段值在转发表中进行索引，从而决定该分组应该被送往哪个输出链路接口。

4. 转发表的配置：

   1. 通过路由选择算法插入转发表的内容

      每台路由器配置路由选择算法，并且实现转发和路由选择功能。一台路由器上的路由选择算法与其他路由器上的路由选择算法进行通信，决定转发表的内容。

   2. 控制平面：SDN 方法

      远程控制器计算和分发转发表供路由器使用。

5. 因特网的网络层提供单一的服务 —— 尽力而为服务。

## 4.2 路由器工作原理

1. 一个路由器的四个组件：

   1. 输入端口

      输入端口的功能：①、执行终结入链路的物理层功能，②、与入链路远端的链路层交互执行链路层功能，③、查找转发表决定到达的分组转发的输出端口

   2. 输出端口

      ①、从交换结构接收分组，②、执行必要的链路层和物理层功能，向输出链路传输分组

   3. 交换结构

      将路由器的输入链路连接到输出链路

   4. 路由选择器

      执行控制平面的功能

2. 路由器的输入端口、交换结构、输出端口几乎用硬件实现。控制平面的功能通常用软件实现并在路由选择器上执行。

3. 通过交换结构，分组能够通过一个输入端口转发到一个输出结构。

   交换结构转发的方式有 3 种：

   1. 通过内存转发
   2. 通过总线转发
   3. 通过互联网络转发

4. 何处出现排队：

   1. 输入排队

      - 多个分组交换到同一输出端口，由于交换结构一次只能将一个分组送往该输出端口，其它分组在输入端口处排队。
      - 并且有输入端口排队的分组会阻塞它后面分组的交换，导致该输入端口的排队。

   2. 输出排队

      多个分组到达同一输出端口时，这些分组会在该输出端口处排队。

5. 分组调度：排队的分组如何经输出端口传输。

   1. 先进先出
   2. 优先权排队
   3. 循环和加权平均排队

## 4.3 网际协议：IPv4、寻址、IPv6及其他

1. 一般的 IP 数据报具有 20 字节的首部。

2. IPv4 的数据包格式：

   - 寿命

     该字段保证数据报不会永远在网络中循环。每一台路由器处理该数据报时，该字段值减 1.

   - 协议

     该字段指示数据报对应的运输层使用的协议。如：协议号值为 6 表明数据部分交给 TCP，值为 17 表明数据部分交给 UDP

   - 首部校验和

   - 源和目的 IP 地址

3. 一个链路层帧所能传输的最大数据量称为 MTU。

4. 片在达到目的地的运输层之前需要重新经过组装。IPv4 的设计者将数据报的重新组装工作放在端系统上。

5. 将 IP 数据报首部中的标识、标志和片偏移字段帮助目的主机执行重新组装数据报的工作。

   - 标识：发送主机每生成一个数据报，为该数据报贴上标识号。
   - 标志：让目的主机相信它已经接收到该数据报最后一个数据片。最后一个数据片标志为 0，其他为 1.
   - 片偏移：指定该片放在原来数据报的哪个位置。

6. IP 要求一个 IP 地址与一个接口相连，而不是与包括该接口的主机或路由器相连。

7. 每个 IP 地址有 32 比特，即 4 个字节，用 点分十进制法 书写。

8. IP 广播地址：255.255.255.255. 当一台主机发出一个目的地址为 255.255.255.255 的数据报时，该报文会交付给同一个网络中所有主机。

9. 使用 DHCP（动态主机配置协议）为主机配置 IP 地址。

10. DHCP 允许主机自动获取一个 IP 地址。

11. DHCP 是一个客户 —— 服务器协议。客户通常是新到达的主机，它要获得包括自身使用的 IP 地址在内的网络配置信息。

12. 新到达的主机通过 DHCP 协议分配 IP 地址：

    1. DHCP 服务器发现

       新到达的主机通过使用 DHCP 发现报文（DHCP discover message）完成。客户在 UDP 分组向端口 67 发送该报文。其中目的地址（广播地址）为 255.255.255.255，源地址为 0.0.0.0

    2. DHCP 服务器提供

       DHCP 服务器收到一个 DHCP 发现报文，用 DHCP 提供报文（DHCP offer message）向客户响应。使用广播的方式。

    3. DHCP 请求

       客户选择一个 DHCP 服务器回送 DHCP 请求报文（DHCP request message）进行响应。

    4. DHCP ACK

       DHCP 服务器用 DHCP ACK 报文（DHCP ACK message）进行响应。

    这个过程完成，客户便获得一个在租用期内可以使用的 IP 地址。




# 五、网络层：控制平面

1. OSPF 是一种运行在单一 ISP 网络中的路由选择算法；

   BGP 是一种在因特网中用于互联所有网络的路由选择算法。

   OSPF、BGP 都是基于每路由器控制对转发表、流表进行配置的。

   

## 5.1 概述

1. 转发表（基于目的地进行转发）和流表（通用转发）是连接路由数据平面和控制平面的首要元素。

2. 通用转发的动作：

   1. 转发一个分组到每个输出端口
   2. 丢弃一个分组或复制一个分组
   3. 改写该分组的第 2、3 或 4 层的某些首部字段

3. 进行转发表和流表的配置：

   - 每路由器控制

     OSPF、BGP 基于每路由器控制

   - 逻辑集中式控制

     可以进行传统的 IP 转发与其他功能（负载共享、防火墙、NAT等）

4. 每路由器控制与逻辑集中式控制的关键差异：

   逻辑集中式控制中的 CA 既不能直接相互交互，也不能主动参与计算转发表。

## 5.2 ✅ 路由选择算法

1. 路由选择算法是为了确定一条从发送方到接收方的最低开销的路由器选择的路径。
2. LS 算法：Dijkstra 算法
3. DV 算法：Bellman — Ford 方程



## 5.3 因特网中自治系统内部的路由选择：OSPF

1. 自治系统（Autonomous System，AS）：由一组处于相同管理控制下的路由器组成。

2. 同一个 AS 中的路由器运行相同的路由选择算法并且有彼此的信息。

3. OSPF（开放最短路优先） 是一个链路状态协议，运行洪泛链路状态信息和 Dijkstra 算法。

4. 使用 OSPF，路由器向自治系统内的所有路由器广播路由选择信息。

5. OSPF 报文由 IP 直接承载，对上层协议值为 89.

6. OSPF 协议：

   1. 自己实现可靠报文传输
   2. 自己实现链路状态广播
   3. 检查链路是否正常运行
   4. 获取相邻路由器的网络范围链路状态的数据库

7. OSPF 协议的优点：

   1. 安全

      报文可以进行简单的加密和 MD5 加密

   2. 多条相同开销的路径

   3. 对单播和多播路由选择的综合支持

   4. 允许单个 AS 中有层次结构

## 5.4 ISP 之间的路由选择：BGP

1. BGP（Border Gateway Protocol，边界网关协议）：因特网中，所有 AS 运行相同的 AS 间路由选择协议，即 BGP。
2. BGP 是一个分布式、异步的协议。
3. BGP 将 AS 连接起来的工作：
   1. 从邻居 AS 获取前缀的可达性信息
   2. 确定到达该前缀的最好路由
4. 在 BGP 中，每对路由器通过使用 179 端口的半永久 TCP 连接交换路由选择信息。

## 5.5 — 5.8

1. SDN 体系结构的四个关键特征：
   1. 基于流转发
   2. 数据平面和控制平面分离
   3. 网络控制功能位于路由器数据平面之外
   4. 可编程的网络
2. ICMP （因特网控制报文协议）被主机和路由器用来彼此沟通网络层的信息。从体系结构上讲，ICMP 位于 IP 之上，因为 ICMP 报文承载在 IP 数据报上。
3. ICMP 最典型的用途是差错报告。ping 程序发送一个 ICMP 类型 8 编码 0 的报文到指定主机。



# 六、链路层和局域网

## 6.1 链路层概述

1. 节点：运行链路层协议的设备称为节点。

   链路：连接相邻节点的通信信道称为链路。

   节点将数据报封装在链路层帧中，沿链路传输，从一个节点到另一个节点。

2. 链路层协议可能提供的服务：

   - 成帧

   - 链路接入

     MAC（Medium Access Control，媒体访问协议）协议规定帧在链路上的传输规则。

   - 可靠交付

     链路层的可靠交付通过确认和重传实现。

     （TCP 的可靠交付通过序号、定时器、校验和、ACK 和 NAK 实现。）

   - 差错检测和纠正

3. MAC（Medium Access Control，媒体访问协议）协议规定帧在链路上的传输规则。

4. 链路层的可靠交付通过确认和重传实现。

5. 链路层的主体部分在网络适配器（网卡，NIC）中实现。网卡的核心是链路层控制器，它是一个实现多种链路层服务的芯片。

## 6.2 差错检验和纠正技术

1. #### 奇偶校验

   1. 单个奇偶校验

      偶校验：保证数据部分加校验位中 1 的个数为偶数个（检验位根据实际情况变化）

   2. 二维奇偶校验

2. #### 检验和

3. #### 循环冗余校验



1. 为什么运输层使用校验和而链路层使用 CRC？

   因为运输层协议大多在端系统上靠软件实现，校验方式应该简单快速；而链路层的差错检测由专门的硬件实现，能快速地执行复杂的 CRC 操作。



## 6.3 多路访问链路和协议

1. 两种网络链路：

   1. 点到点链路

      点对点协议（PPP），高级数据链路控制（HDLC）

   2. 广播链路：多个发送方和接收方连接在一个信道上

      以太网、无线局域网

2. 多路访问问题：协调多个发送方和接收方对同一个共享广播信道的访问。

3. 多路访问协议：规定了多个发送方和接收方在广播信道的传输行为。

4. 多路访问协议

   1. #### 信道划分协议

      TDM，FDM

   2. #### 随机接入协议

      1. 随机接入协议中，①. 一个节点以信道的全部速率发送，②. 发生碰撞时，节点一直重发该帧，直至不发生碰撞为止，③. 发生碰撞，节点等一个随机时延后，再重发分组。 

   3. #### 轮流协议

## 6.4 交换局域网

1. MAC 广播地址：FF-FF-FF-FF-FF-FF
2. ARP （地址解析协议）进行 IP 地址和 MAC 地址间的相互转化。
3. ARP 只为同一个子网内的主机和路由器接口解析 IP 地址。
4. 查询 ARP 报文在广播帧中发送，响应 ARP 报文在标准帧中发送。
5. 以太网向网络层提供无连接、不可靠的服务。
6. 以太网基于交换机的星型拓扑，采用的是存储转发分组交换。





