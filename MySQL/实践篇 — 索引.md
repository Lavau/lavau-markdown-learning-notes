[TOC]

# 10、MySQL 为什么有时候会选错索引？

执行你写的 SQL 语句时，使用哪个索引由 MySQL 自己决定。

## 10.1 MySQL 自己选定索引的原理

MySQL 自己选定索引时，主要根据下面三个条件：

1. 扫描行数
2. 排序
3. 临时表

### 10.1.1 扫描行数

选择索引是优化器的任务。

选择索引的目的又是为了找到一个最优的执行方案：以最小的代价执行语句。在数据库中，扫描行数是影响执行代价的因素之一 —— 扫描行数越少，访问磁盘数据次数越少，消耗 CPU 的资源越少。

#### 10.1.1.1 判断扫描行数

MySQL 真正执行语句前，只是根据 ***统计信息估算记录数*** ：一个索引的不同值越多，它的区分度越好；不同的值的个数又称为 “基数”。

##### 10.1.1.1.1 MySQL 如何得到索引基数

> MySQL 通过采样统计的方式计算某个索引的基数。

- *注意：*

  表会更新，索引的统计信息也会更新。当变更的数据行数超过 1/M 的时候，会自动触发重新做一次索引统计。

##### 10.1.1.1.2 MySQL 如何查看索引统计值

> `show index from 表XX`
>
> 输出结果的 `cardinality` 列为索引统计值

#### 10.1.1.2 查看具体的语句的扫描行数

> `explain XXXX  `
>
> 在输出结果中，可以分析 XXXX 语句执行的分析

如果显示的统计信息不对，使用 `analyze table X` 命令，重新统计索引信息。

#### 10.1.1.3 说明

MySQL 在判断扫描行数时，可能会把 回表 花费的时间也算进来。

## 10.2 我们如何避免 MySQL 选错索引？

- 采用 `force index` 强行选择一个索引

  当 MySQL 没有选择对正确的索引时，我们可以给它指定它应该使用的索引。

> 但其实使用 force index 最主要的问题还是变更的及时性。因为选错索引的情况还是比较少出现的，所以开发的时候通常不会先写上 force index。而是等到线上出现问题的时候，你才会再去修改 SQL 语句、加上 force index。但是修改之后还要测试和发布，对于生产系统来说，这个过程不够敏捷。所以，数据库的问题最好还是在数据库内部来解决。那么，在数据库里面该怎样解决呢

- 考虑修改语句，引导 MySQL 使用我们期望的索引

  正如 10.1 所说，MySQL 选定索引时是根据多个条件综合判断的。我们可以通过使用 ***排序*** 引导 MySQL 使用我们期望的索引

- 在有些场景下，可以新建一个更合适的索引，来提供给优化器做选择，或删掉误用的索引

