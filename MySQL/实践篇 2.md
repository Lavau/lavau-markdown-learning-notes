[TOC]

# 11、怎么给字符串字段加索引？

在前面一张中已经学到了字符串字段的 ***最左前缀匹配规则***  。那么我们就跟这个规则字符串建立索引。

#### 0.0.0.1 为什么要加要给字符串字段加索引？

首先要明白：如果不给某个常用的字符串字段建索引，那个相关语句在根据它进行操作时会进行全表扫描（本节课开头局的例子）。

# 11.1 最左前缀规则加索引

> 最左字段加索引：可以定义字符串的最左的几个字段作为索引
>
> 默认加索引：默认地，字符串索引做索引不指定长度，索引默认包含整个字符串。

## 11.1.1 注意：

> > 使用前缀索引，定义好长度 —— 既节省空间，用避免额外的查询

- 节省空间

  相比较 “默认加索引” 而言，使用具有高区分度的最前面的几个字符作为索引，能节省空间（索引选取的越长，占用的磁盘空间就越大，相同的数据页能放下的索引值就越少，搜索的效率也就会越低）

- 避免额外的查询

  找出最前面的字符中最具区分度的长度，避免在使用索引树过程中的重复查询

  

**特别说明： **

> 在建立索引时关注的是区分度，区分度越高越好。因为区分度越高，意味着重复的键值越少

## 11.1.2 前缀索引对覆盖索引的影响 

使用前缀索引就用不上覆盖索引对查询性能的优化了，这也是在选择是否使用前缀索引时需要考虑的一个因素

# 12、为什么我的 MySQL会“抖”一下？

> 情景导入：
>
> 一条 SQL 语句平常执行很快，偶尔某次会变得很慢。这种场景又难以复现。

## 12.1 概述

### 12.1.1 WAL 

在第二篇文章里（日志系统：一条 SQL 更新语句是如何执行的）我们了解了 ***WAL （Write-Ahead Logging） 机制*** ：先写日志（redo log），再写磁盘。

### 12.1.2 名词了解

- **flush**

  把内存里的数据写入磁盘的过程

- **脏页**

  内存数据页与磁盘数据页内容不一致，称这个内存页为 **脏页**

- **干净页**

  内存数据写入磁盘后，内存数据与磁盘数据一致，称为 **干净页**





“抖的”那一下很大程度上是由于 MySQL 从 redo log 向磁盘写数据 —— MySQL 在刷新脏页。

## 12.2 MySQL 何时进行 flush？

1. InnoDB 的 redo log 写满，系统停止所有的更新操作
2. 系统内存不足 —— 需要新内存页时，内存不够，淘汰一些数据页，留出内存给其它数据页使用
3. MySQL 认为系统 “空闲”时，MySQL 把内存中的脏页 flush 到磁盘
4. MySQL 正常关闭时，MySQL 把内存中的脏页 flush 到磁盘

### 12.2.1 四种场景对性能的影响

- 第三种与第四种对性能的影响微乎其微
- 第一种情况 InnoDB 要尽量避免 —— 出现这种情况后，整个系统的更新被阻塞
- 第二种情况（内存不够，脏页写入磁盘）应该是常态

#### 12.2.1.1 补充

InnoDB 通过缓冲池 buffer pool 管理内存。

池中内存页有三种状态：

- 未被使用
- 使用了，为干净页
- 使用了，为脏页